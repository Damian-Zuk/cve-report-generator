<!DOCTYPE html>
<html>
<head>
    <title>CVE Report Viewer</title>
    <link rel="stylesheet" href="resources/style.css">
</head>
<body>

<div class="header">
    <h2>CVE Report Viewer</h2>
</div>

<div id="upload-file-container">
    <label for="input-file" id="drop-area">
        <input type="file" id="input-file" accept="application/json" hidden>
        <div class="drop-area-content">
            <svg fill="white" height="120px" width="120px" version="1.1" id="upload-icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
            viewBox="0 0 471.2 471.2" xml:space="preserve">
            <g>
                <path d="M457.7,230.15c-7.5,0-13.5,6-13.5,13.5v122.8c0,33.4-27.2,60.5-60.5,60.5H87.5c-33.4,0-60.5-27.2-60.5-60.5v-124.8
                    c0-7.5-6-13.5-13.5-13.5s-13.5,6-13.5,13.5v124.8c0,48.3,39.3,87.5,87.5,87.5h296.2c48.3,0,87.5-39.3,87.5-87.5v-122.8
                    C471.2,236.25,465.2,230.15,457.7,230.15z"/>
                <path d="M159.3,126.15l62.8-62.8v273.9c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5V63.35l62.8,62.8c2.6,2.6,6.1,4,9.5,4
                    c3.5,0,6.9-1.3,9.5-4c5.3-5.3,5.3-13.8,0-19.1l-85.8-85.8c-2.5-2.5-6-4-9.5-4c-3.6,0-7,1.4-9.5,4l-85.8,85.8
                    c-5.3,5.3-5.3,13.8,0,19.1C145.5,131.35,154.1,131.35,159.3,126.15z"/>
            </g>
            </svg>
            <p id="upload-filename">Drag Report File</p>
        </div>
    </label>
</div>

<div id="device-list"></div>

<div class="footer">
    <div>
        <a href="https://zsz.prz.edu.pl/en/" target="_blank">
            <img class="university-logo" src="resources/prz-weii-zsz-logo.png" alt="Rzeszow University of Technology">
        </a>
        <a href="https://github.com/Damian-Zuk/cve-report-generator" target="_blank">
            <img class="github-logo" src="resources/github-mark-white.png" alt="github">
        </a>
    </div>
    <p>Security of IoT System Course Project &copy; Rzesz√≥w 2024</p>
</div>

<script type="text/javascript">
    const dropArea = document.getElementById('drop-area');
    const inputFile = document.getElementById('input-file');

    inputFile.addEventListener('change', function(event) {
        const files = event.target.files;
        if (files.length) {
            processFile(files[0]);
        }
    });

    dropArea.addEventListener('dragover', (event) => {
        event.stopPropagation();
        event.preventDefault();
        event.dataTransfer.dropEffect = 'copy';
        dropArea.style.backgroundColor = '#2f2f2f';
    });

    dropArea.addEventListener('dragleave', (event) => {
        event.stopPropagation();
        event.preventDefault();
        dropArea.style.backgroundColor = '#1e1e1e';
    });

    dropArea.addEventListener('drop', (event) => {
        event.stopPropagation();
        event.preventDefault();
        dropArea.style.backgroundColor = '#1e1e1e';
        const files = event.dataTransfer.files;
        if (files.length) {
            processFile(files[0]);
        }
    });

    function dropAreaShrink(filename) {
        dropArea.classList.add('drop-area-small');
        document.getElementById('upload-file-container').classList.add('upload-file-container-small');
        document.getElementById('upload-filename').innerText = filename;
        document.getElementById('upload-icon').style.display = 'none';
    }

    function processFile(file) {
        const reader = new FileReader();
        reader.readAsText(file);
        reader.onload = function(event) {
            try {
                const reportData = JSON.parse(event.target.result);
                dropAreaShrink(file.name);
                document.getElementById('device-list').innerHTML = '';
                for (let device of reportData) {
                    createCollapsibleNode(device);
                }
            } catch (error) {
                console.error('Error parsing JSON:', error);
            }
        };
        reader.onerror = function() {
            console.error('Error reading file');
        };
    }

    function cpeButton(cpe) {
        return `
        <a href="https://nvd.nist.gov/products/cpe/search/results?namingFormat=2.3&keyword=${cpe}" target="_blank">
            <button class="cpe-button">View CPE</button>
        </a>`;
    }

    function cveReportSection(cve_data) {
        let html = `
            <p>Found a total of ${cve_data.cve_total} CVEs.</p> 
            <div class="cve-list">
        `;
        for (const cve of cve_data.cve_list) {
            html += `
                <div class="cve-container">
                    <a href="https://nvd.nist.gov/vuln/detail/${cve.id}" target="_blank"><b>${cve.id}</b></a> 
                    <span class="cve-score">Score <b>${cve.score}</b> (${cve.metric})</span>
                    <span class="cve-severity cve-severity-${cve.severity.toLowerCase()}">${cve.severity}</span> 
                    <p class="cve-description">${cve.description}</p>
                    <b>Published:</b> ${cve.published.substr(0, cve.published.indexOf('.')).replace('T', ' at ')} 
                </div>
            `;
        }
        return html + "</div>";
    }

    function createCollapsibleNode(deviceData) {
        // Create report elements
        let deviceList = document.getElementById('device-list');
        let deviceReportContainer = document.createElement('div');
        let button = document.createElement('button');
        let content = document.createElement('div');
        content.className = 'report-content';
        deviceReportContainer.className = 'device-report-container';
        deviceReportContainer.appendChild(button)
        deviceReportContainer.appendChild(content)
        deviceList.appendChild(deviceReportContainer);
        
        // Device report collapse button
        button.className = 'btn-collapsible';
        button.innerText = deviceData.model || 'Unknown Device Model';
        if (deviceData.hasOwnProperty('ipv4')) {
            button.innerText += ` (${deviceData['ipv4']})`;
        }
        button.addEventListener('click', function() {
            this.classList.toggle('active');
            let block = this.nextElementSibling;
            block.style.display = block.style.display === 'block' ? 'none' : 'block';
        });

        // ============ Device details ============
        let html = '<h3>Device Details</h3> <hr /><br />';

        for (const [propertyName, property] of Object.entries(deviceData)) {
            switch(propertyName) {
            
            case 'firmware_version':
                html += '<section><b>FIRMWARE:</b> ' + property;
                if (deviceData.hasOwnProperty('cpe'))
                    html += cpeButton(deviceData.cpe);
                html += '</section>';
                break;
  
            case 'port_services':
                html += '<section><b>OPEN PORTS AND SERVICES:</b><br /><br />';
                for (const [port, service] of Object.entries(property)) {
                    html += `<div class="indent-block">
                        <span class="port-number">${port}</span><span class="service-name">${service.name}</span>`;
                    if (service.hasOwnProperty('product')) {
                        html += " " + service.product;
                        if (service.hasOwnProperty('version')) {
                            html += " " + service.version;
                        }
                        if (service.hasOwnProperty('cpe')) {
                            html += cpeButton(service.cpe);
                        }
                    }
                    html += '</div><br />';
                }
                html += '</section>';   
                break;
            
            case 'os':
                html += '<section><b>OPERATING SYSTEM:</b><br /><div class="indent-block">';
                const nmapMatch = property.hasOwnProperty('nmap_match');
                html += `<p><b>${nmapMatch ? 'Nmap match:' : 'Name:'}</b> ${property.name}</p> `;
                if (nmapMatch) {
                    html += `<p><b>Nmap accuracy:</b> ${property.accuracy}%</p>`;
                }
                for (const os_class of property.class) {
                    html += `<div class="os-class">
                        <p><b>Vendor:</b> ${os_class.vendor}</p>
                        <p><b>Family:</b> ${os_class.family}</p>
                        <p><b>Version:</b> ${os_class.version + (os_class.hasOwnProperty('cpe') ? cpeButton(os_class.cpe) : '')}</p>
                    `;
                    if (nmapMatch) {
                        html += `<p><b>Nmap accuracy:</b> ${os_class.accuracy}%</p>`;
                    }
                    html += '</div>';
                }
                html += '</div></section>'
                break;
            
            case 'cpe':
                break;
            case 'search_cpe_by_model_only':
                break;
            case 'vulnerabilities':
                break;
            default:
                html += `<section><b>${propertyName.toUpperCase().replaceAll('_', ' ')}:</b> ${String(property)}</section>`;
            }
        }

        // ============ Security report ============ 
        if (deviceData.hasOwnProperty('vulnerabilities')) {
            const vulnerabilities = deviceData['vulnerabilities'];
            html += '<h3 style="margin-top: 40px">Security Report</h3><hr />';
            
            // Firmware
            html += '<div class="cve-report-content">';
            html += `<section><strong>Firmware vulnerabilities</strong><div class="indent-block"> ${
                vulnerabilities.hasOwnProperty('firmware') ? cveReportSection(vulnerabilities.firmware) : 'Unknown.'
            }</div></section>`;
            
            // Port services
            html += '<section><strong>Port service vulnerabilities</strong><div class="indent-block">';
            if (vulnerabilities.hasOwnProperty('service')) {
                for (const [service_name, service_cve] of Object.entries(vulnerabilities.service)) {
                    html += `&#x2022; <b>${service_name}</b> `;
                    html += cveReportSection(service_cve);
                }
            } else html += 'Unknown.';
            html += '</div></section>';

            // Operating system
            html += '<section><strong>Operating system vulnerabilities</strong><div class="indent-block">';
            if (vulnerabilities.hasOwnProperty('os')) {
                if (vulnerabilities.os.hasOwnProperty('message')) {
                    html += vulnerabilities.os.message;
                } else {
                    for (const [os_name, os_cve] of Object.entries(vulnerabilities.os)) {
                        html += `&#x2022; <b>${os_name}</b> `;
                        html += cveReportSection(os_cve);
                    }
                }
            } else html += 'Unknown.';
            html += '</div></section>';
            html += '</div>'
        }

        // Set HTML content
        content.innerHTML = html;
    }
</script>

</body>
</html>
